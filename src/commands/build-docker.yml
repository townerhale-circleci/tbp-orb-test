description: Builds a docker image and pushes it to ECR.
parameters:
  app_version:
    type: string
    default: latest
    description: app_version to tag the docker image with.
  platform:
    type: string
    description: The platform to build the docker image for.
  repo:
    type: string
    description: The name of the ECR repository to push the image to.
  dockerfile:
    type: string
    default: Dockerfile
    description: The path to the Dockerfile to build.
  extra_build_args:
    type: string
    default: ""
    description: Extra arguments to pass to the docker build command.
steps:
  - checkout
  # Customer-specific steps (commented out for testing)
  # - aws-login:
  #     environment: tbp
  # - lint-docker:
  #     dockerfile: << parameters.dockerfile >>
  - aws-cli/setup:
      role_arn: ${AWS_ROLE_ARN}
      region: us-east-1
  - run:
      name: Login to ECR
      command: |
        aws ecr get-login-password --region us-east-1 | \
        docker login --username AWS --password-stdin ${AWS_ECR_REGISTRY_ID}.dkr.ecr.us-east-1.amazonaws.com
  - run:
      name: Setup buildx
      command: |
        docker buildx create --use --name circleci || docker buildx use circleci
        docker buildx inspect --bootstrap
  - run:
      name: Build Docker image with buildx
      command: |
        echo "Building << parameters.repo >>:<< parameters.app_version >>"
        echo "Platform: << parameters.platform >>"
        echo "Extra args: << parameters.extra_build_args >>"

        docker buildx build \
          --load \
          --platform << parameters.platform >> \
          << parameters.extra_build_args >> \
          -t ${AWS_ECR_REGISTRY_ID}.dkr.ecr.us-east-1.amazonaws.com/<< parameters.repo >>:<< parameters.app_version >> \
          -f << parameters.dockerfile >> \
          .
  - run:
      name: Push image to ECR
      command: |
        docker push ${AWS_ECR_REGISTRY_ID}.dkr.ecr.us-east-1.amazonaws.com/<< parameters.repo >>:<< parameters.app_version >>
