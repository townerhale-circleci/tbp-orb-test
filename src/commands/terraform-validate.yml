description: Validate opentofu configuration
parameters:
  root-dir:
    type: string
    default: terraform
    description: Path to root of terraform directory
  environment:
    type: string
    default: ""
    description: Path inside of terraform to act on.
  commit:
    type: boolean
    default: true
    description: Should we commit the changes after generating docs
  workspace:
    type: string
    default: ""
    description: If we need to specify a terraform workspace, what is it?
  errors:
    type: boolean
    default: true
    description: Should we raise errors in our tf checks
steps:
  - terraform-install
  - run:
      name: install tflint
      environment:
        # https://github.com/terraform-linters/tflint/releases
        TFLINT_VERSION: v0.59.1
      command: <<include(scripts/install-tflint.sh)>>
  - run:
      name: tflint init
      command: tflint --init
      environment:
        TF_WORKSPACE: << parameters.workspace >>
  - run:
      name: run tflint
      command: <<include(scripts/run-tflint.sh)>>
      environment:
        TF_WORKSPACE: << parameters.workspace >>
        ROOT_DIR: << parameters.root-dir >>
        FAIL_ON_ERROR: << parameters.errors >>
  - store_test_results:
      path: tflint-out.xml
  - run:
      name: terraform validate
      command: cd << parameters.root-dir >>/<< parameters.environment >> && tofu validate -no-color
      environment:
        TF_WORKSPACE: << parameters.workspace >>
  - run:
      name: opentofu fmt
      command: cd << parameters.root-dir >>/<< parameters.environment >> && tofu fmt -check -recursive
  - when:
      condition: << parameters.commit >>
      steps:
        - run:
            environment:
              ROOT_DIR: << parameters.root-dir >>
            name: Check in diff
            command: <<include(scripts/commit-terraform.sh)>>
